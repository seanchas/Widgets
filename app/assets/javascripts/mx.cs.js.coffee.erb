global = module?.exports ? ( exports ? this )

global.mx       ||= {}
global.mx.cs   ||= {}

scope = global.mx.cs

cs_host = "<%= Rails.application.config.cs_host %>"

$ = jQuery


data = (engine, market, param, options = {}) ->
    deferred = new $.Deferred
    
    key = mx.utils.sha1 JSON.stringify ['chart', arguments...]
    
    $.ajax
        url: "#{cs_host}/engines/#{engine}/markets/#{market}/securities/#{param}.json?callback=?"
        data: options
        dataType: 'jsonp'
        jsonpCallback: "callback_#{key}"
        cache: true
    .then (json) ->
        deferred.resolve json
    
    deferred.promise()


_.extend scope,
    data:            data
